{% extends 'base_content.html' %}
{% load static %}

{% block body_class %}user-profile-bg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'user_profile.css' %}">
<link rel="stylesheet" href="{% static 'navbar.css' %}">
{% endblock %}

{% block content %}

<!-- Dust particles -->
<div class="profile-particles">
  {% for _ in "123456789012345678901234567890" %}
    <span></span>
  {% endfor %}
</div>

<div class="container">
  <div class="row">
    <div class="col-12">
      
      <!-- Profile Header -->
      <div class="profile-header">
        <!-- Settings Icon (own profile only) - Top Right -->
        {% if user.is_authenticated and user.id == profile_user.id %}
          <a href="{% url 'profile' %}" class="btn-settings-icon" title="Settings" style="position: absolute !important; top: 20px !important; right: 20px !important; width: 45px; height: 45px; display: flex !important; align-items: center; justify-content: center; background: rgba(92, 214, 214, 0.2) !important; border: 2px solid #5cd6d6 !important; border-radius: 50%; color: #5cd6d6 !important; font-size: 1.3rem; text-decoration: none; z-index: 100;">
            <i class="bi bi-gear-fill"></i>
          </a>
        {% endif %}

        <h1>{{ profile_user.full_name }}</h1>
        <div class="profile-username">{{ profile_user.username }}</div>

        <div class="profile-stats">
          <div class="stat-item">
            <a href="{% url 'user_followers' profile_user.id %}">
              <span class="stat-number">{{ followers_count }}</span> Followers
            </a>
          </div>
          <div class="stat-item">
            <a href="{% url 'user_following' profile_user.id %}">
              <span class="stat-number">{{ following_count }}</span> Following
            </a>
          </div>
        </div>

        <!-- Follow/Unfollow Buttons -->
        {% if user.is_authenticated and user.id != profile_user.id %}
          {% if is_following %}
            <form method="post" action="{% url 'unfollow_user' profile_user.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger">Unfollow</button>
            </form>

          {% elif request_pending %}
            <form method="post" action="{% url 'cancel_follow_request' profile_user.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary">Requested (Cancel)</button>
            </form>

          {% else %}
            <form method="post" action="{% url 'follow_user' profile_user.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary">
                {% if profile_user.is_private %}Request to Follow{% else %}Follow{% endif %}
              </button>
            </form>
          {% endif %}
        {% endif %}

        <!-- Incoming Friend Request (if exists) -->
        {% if user.is_authenticated and user.id != profile_user.id and incoming_request %}
          <div class="mt-3">
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.75rem;">
              {{ profile_user.username }} has sent you a friend request.
            </p>
            <form method="post" action="{% url 'accept_friend_request' incoming_request.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm">Accept</button>
            </form>
            <form method="post" action="{% url 'reject_friend_request' incoming_request.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary btn-sm">Reject</button>
            </form>
          </div>
        {% endif %}

        <!-- Outgoing Friend Request (if exists) -->
        {% if user.is_authenticated and user.id != profile_user.id and outgoing_request %}
          <div class="mt-3">
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.75rem;">Friend request pending</p>
            <form method="post" action="{% url 'cancel_follow_request' profile_user.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary">Requested (Cancel)</button>
            </form>
          </div>
        {% endif %}
      </div>

      <!-- Follow Requests (only for own profile AND private account AND has requests) -->
      {% if user.is_authenticated and user.id == profile_user.id and profile_user.is_private and incoming_follow_requests %}
        <div class="requests-card">
          <h3>Follow requests</h3>
          <ul class="list-group">
            {% for fr in incoming_follow_requests %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{% url 'user_profile' fr.from_user.id %}">
                  {{ fr.from_user.username }}
                </a>
                <div>
                  <form method="post" action="{% url 'accept_follow_request' fr.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm">Accept</button>
                  </form>
                  <form method="post" action="{% url 'reject_follow_request' fr.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Reject</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <!-- User Recipes Section -->
      <div>
        {% include 'user_recipes.html' %}
      </div>

      <!-- Back Button -->
      <div class="text-center mt-4">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}