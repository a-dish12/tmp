{% extends 'base_content.html' %}
{% load static %}

{% block body_class %}user-profile-bg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'user_profile.css' %}?v=1001">
<link rel="stylesheet" href="{% static 'navbar.css' %}">
{% endblock %}

{% block content %}

<!-- Dust particles -->
<div class="profile-particles">
  {% for _ in "123456789012345678901234567890" %}
    <span></span>
  {% endfor %}
</div>

<div class="container">
  <div class="row">
    <div class="col-12">
      
      <!-- Profile Header -->
      <div class="profile-header">
        <!-- Settings Icon (own profile only) - Top Right -->
        {% if user.is_authenticated and user.id == profile_user.id %}
          <a href="{% url 'profile' %}" class="btn-settings-icon" title="Settings">
            <i class="bi bi-gear-fill"></i>
          </a>
        {% endif %}

        <h1>{{ profile_user.full_name }}</h1>
        <div class="profile-username">{{ profile_user.username }}</div>

        <div class="profile-stats">
          <div class="stat-item">
            <a href="{% url 'user_followers' profile_user.id %}">
              <span class="stat-number">{{ followers_count }}</span> Followers
            </a>
          </div>
          <div class="stat-item">
            <a href="{% url 'user_following' profile_user.id %}">
              <span class="stat-number">{{ following_count }}</span> Following
            </a>
          </div>
        </div>

        <!-- Follow/Unfollow Buttons -->
        {% if user.is_authenticated and user.id != profile_user.id %}
          {% if is_following %}
            <form method="post" action="{% url 'unfollow_user' profile_user.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger">Unfollow</button>
            </form>

          {% elif request_pending %}
            <form method="post" action="{% url 'cancel_follow_request' profile_user.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary">Requested (Cancel)</button>
            </form>

          {% else %}
            <form method="post" action="{% url 'follow_user' profile_user.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary">
                {% if profile_user.is_private %}Request to Follow{% else %}Follow{% endif %}
              </button>
            </form>
          {% endif %}
        {% endif %}

        <!-- Incoming Friend Request (if exists) -->
        {% if user.is_authenticated and user.id != profile_user.id and incoming_request %}
          <div class="mt-3">
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.75rem;">
              {{ profile_user.username }} has sent you a friend request.
            </p>
            <form method="post" action="{% url 'accept_friend_request' incoming_request.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm">Accept</button>
            </form>
            <form method="post" action="{% url 'reject_friend_request' incoming_request.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary btn-sm">Reject</button>
            </form>
          </div>
        {% endif %}

        <!-- Outgoing Friend Request (if exists) -->
        {% if user.is_authenticated and user.id != profile_user.id and outgoing_request %}
          <div class="mt-3">
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.75rem;">Friend request pending</p>
            <form method="post" action="{% url 'cancel_follow_request' profile_user.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary">Requested (Cancel)</button>
            </form>
          </div>
        {% endif %}
      </div>

      <!-- Follow Requests (only for own profile AND private account AND has requests) -->
      {% if user.is_authenticated and user.id == profile_user.id and profile_user.is_private and incoming_follow_requests %}
        <div class="requests-card">
          <h3>Follow requests</h3>
          <ul class="list-group">
            {% for fr in incoming_follow_requests %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{% url 'user_profile' fr.from_user.id %}">
                  {{ fr.from_user.username }}
                </a>
                <div>
                  <form method="post" action="{% url 'accept_follow_request' fr.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm">Accept</button>
                  </form>
                  <form method="post" action="{% url 'reject_follow_request' fr.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Reject</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <!-- My Recipes Section -->
      <div class="my-recipes-section">
        <h3 class="section-title">{% if is_own_profile %}My Recipes{% else %}Recipes{% endif %}</h3>
        
        {% if is_own_profile %}
          <div class="action-buttons">
            <a href="{% url 'create_recipe' %}" class="filters-apply-btn">
              Create New Recipe
            </a>
          </div>
        {% endif %}
        
        {% if profile_user.is_private and not is_following and not is_own_profile %}
          <!-- Private account, not following -->
          <div class="empty-state">
            <p>This account is private.</p>
            <p>Follow this account to see their recipes.</p>
          </div>
        {% elif recipes %}
          <div class="recipe-grid">
            {% for recipe in recipes %}
              <a href="{% url 'recipe_detail' pk=recipe.pk %}" class="recipe-card">
                
                <div class="recipe-image" {% if recipe.image_url %}style="background-image: url('{{ recipe.image_url }}');"{% elif recipe.image %}style="background-image: url('{{ recipe.image.url }}');"{% endif %}></div>
                
                <h5 class="recipe-title">
                  {{ recipe.title }}
                  {% if recipe.get_active_viewers >= 3 %}
                    <span class="badge bg-danger ms-1" title="Trending - {{ recipe.get_active_viewers }} viewing now">üî• Trending</span>
                  {% endif %}
                </h5>
                
                <p class="recipe-desc">
                  {{ recipe.description|truncatewords:18 }}
                </p>
                
                <div class="recipe-meta">
                  <span>By {{ recipe.author.username }}</span>
                  <span>Prep time: {{ recipe.time }} minutes ¬∑ {{ recipe.meal_type|capfirst }}</span>
                </div>
                
                <div class="recipe-rating">
                  {% with avg=recipe.average_rating %}
                    {% for _ in "12345" %}
                      <span class="{% if forloop.counter <= avg %}filled{% endif %}">‚òÖ</span>
                    {% endfor %}
                  {% endwith %}
                  <span class="rating-num">
                    {{ recipe.average_rating|floatformat:1 }}
                  </span>
                  <span class="text-muted ms-2" style="font-size: 0.85rem;">
                    üëÅÔ∏è {{ recipe.total_views }} view{% if recipe.total_views != 1 %}s{% endif %}
                  </span>
                </div>
                
              </a>
            {% endfor %}
          </div>
          
          {% if is_paginated %}
            <nav aria-label="My recipes pagination" class="mt-4">
              <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                  </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                  {% if num == page_obj.number %}
                    <li class="page-item active" aria-current="page">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        {% else %}
          <div class="empty-state">
            {% if is_own_profile %}
              <p>You haven't created any recipes yet.</p>
              <a href="{% url 'create_recipe' %}" class="filters-apply-btn">
                Create Your First Recipe
              </a>
            {% else %}
              <p>{{ profile_user.first_name|default:profile_user.username }} hasn't posted any recipes yet.</p>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Back Button -->
      <div class="text-center mt-4">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}