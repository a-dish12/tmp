{% extends 'base_content.html' %}
{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Find Users</h1>
      
      <!-- Search Bar -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control" 
              id="userSearchInput" 
              placeholder="Search by username or name..."
              autocomplete="off"
            >
          </div>
          <small class="text-muted">
            Search for users by username, first name, or last name
          </small>
        </div>
      </div>

      <!-- Results Count -->
      <div id="resultsCount" class="mb-3">
        <span class="badge bg-secondary">{{ users.count }} user{{ users.count|pluralize }} found</span>
      </div>

      <!-- User List -->
      <div id="userList" class="row">
        {% for user in users %}
        <div class="col-md-6 col-lg-4 mb-3 user-card" data-user-id="{{ user.id }}">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex align-items-center">
              <img 
                src="{{ user.mini_gravatar }}" 
                alt="{{ user.username }}" 
                class="rounded-circle me-3"
                style="width: 50px; height: 50px;"
              >
              <div class="flex-grow-1">
                <h6 class="card-title mb-1">{{ user.full_name }}</h6>
                <p class="card-text text-muted small mb-0">{{ user.username }}</p>
              </div>
              <a href="{% url 'user_profile' user.id %}" class="btn btn-sm btn-primary">
                View Profile
              </a>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No users found.
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Loading Indicator -->
      <div id="loadingIndicator" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Debounce function to prevent too many AJAX requests
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Search users via AJAX
function searchUsers(query) {
  const userList = document.getElementById('userList');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const resultsCount = document.getElementById('resultsCount');
  
  // Show loading indicator
  loadingIndicator.style.display = 'block';
  userList.style.opacity = '0.5';
  
  // Make AJAX request
  fetch(`/search-users-ajax/?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
      // Update results count
      resultsCount.innerHTML = `<span class="badge bg-secondary">${data.count} user${data.count !== 1 ? 's' : ''} found</span>`;
      
      // Clear current list
      userList.innerHTML = '';
      
      // Display users
      if (data.users.length === 0) {
        userList.innerHTML = `
          <div class="col-12">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> No users found matching your search.
            </div>
          </div>
        `;
      } else {
        data.users.forEach(user => {
          const userCard = `
            <div class="col-md-6 col-lg-4 mb-3 user-card" data-user-id="${user.id}">
              <div class="card h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                  <img 
                    src="${user.gravatar_url}" 
                    alt="${user.username}" 
                    class="rounded-circle me-3"
                    style="width: 50px; height: 50px;"
                  >
                  <div class="flex-grow-1">
                    <h6 class="card-title mb-1">${user.full_name}</h6>
                    <p class="card-text text-muted small mb-0">${user.username}</p>
                  </div>
                  <a href="/user/${user.id}/" class="btn btn-sm btn-primary">
                    View Profile
                  </a>
                </div>
              </div>
            </div>
          `;
          userList.innerHTML += userCard;
        });
      }
      
      // Hide loading indicator
      loadingIndicator.style.display = 'none';
      userList.style.opacity = '1';
    })
    .catch(error => {
      console.error('Error searching users:', error);
      loadingIndicator.style.display = 'none';
      userList.style.opacity = '1';
      userList.innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> An error occurred while searching. Please try again.
          </div>
        </div>
      `;
    });
}

// Create debounced search function (300ms delay)
const debouncedSearch = debounce(searchUsers, 300);

// Attach event listener to search input
document.getElementById('userSearchInput').addEventListener('input', function(e) {
  const query = e.target.value.trim();
  debouncedSearch(query);
});
</script>
{% endblock %}
