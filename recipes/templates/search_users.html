{% extends 'base_content.html' %}
{% load static %}

{% block body_class %}find-users-bg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'find_users.css' %}">
<link rel="stylesheet" href="{% static 'navbar.css' %}">
{% endblock %}

{% block content %}

<!-- Dust particles -->
<div class="find-users-particles">
  {% for _ in "123456789012345678901234567890" %}
    <span></span>
  {% endfor %}
</div>

<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>Find Users</h1>
      
      <!-- Search Bar -->
      <div class="search-card">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            id="userSearchInput" 
            placeholder="Search by username or name..."
            autocomplete="off"
          >
        </div>
        <small class="text-muted">
          Search for users by username, first name, or last name
        </small>
      </div>

      <!-- Results Count -->
      <div id="resultsCount" class="results-count">
        <span class="badge">{{ users.count }} user{{ users.count|pluralize }} found</span>
      </div>

      <!-- User List -->
      <div id="userList" class="user-grid">
        {% for user in users %}
        <div class="user-card-item" data-user-id="{{ user.id }}">
          <img 
            src="{{ user.mini_gravatar }}" 
            alt="{{ user.username }}" 
            class="user-avatar"
          >
          <div class="user-info">
            <h6 class="user-name">{{ user.full_name }}</h6>
            <p class="user-username">{{ user.username }}</p>
          </div>
          <div class="user-actions">
            <a href="{% url 'user_profile' user.id %}" class="btn-view-profile">
              View Profile
            </a>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No users found.
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Loading Indicator -->
      <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Debounce function to prevent too many AJAX requests
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Search users via AJAX
function searchUsers(query) {
  const userList = document.getElementById('userList');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const resultsCount = document.getElementById('resultsCount');
  
  // Show loading indicator
  loadingIndicator.classList.add('active');
  userList.classList.add('loading');
  
  // Make AJAX request
  fetch(`/search-users-ajax/?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
      // Update results count
      resultsCount.innerHTML = `<span class="badge">${data.count} user${data.count !== 1 ? 's' : ''} found</span>`;
      
      // Clear current list
      userList.innerHTML = '';
      
      // Display users
      if (data.users.length === 0) {
        userList.innerHTML = `
          <div class="col-12">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> No users found matching your search.
            </div>
          </div>
        `;
      } else {
        data.users.forEach(user => {
          const userCard = `
            <div class="user-card-item" data-user-id="${user.id}">
              <img 
                src="${user.gravatar_url}" 
                alt="${user.username}" 
                class="user-avatar"
              >
              <div class="user-info">
                <h6 class="user-name">${user.full_name}</h6>
                <p class="user-username">${user.username}</p>
              </div>
              <div class="user-actions">
                <a href="/users/${user.id}/" class="btn-view-profile">
                  View Profile
                </a>
              </div>
            </div>
          `;
          userList.innerHTML += userCard;
        });
      }
      
      // Hide loading indicator
      loadingIndicator.classList.remove('active');
      userList.classList.remove('loading');
    })
    .catch(error => {
      console.error('Error searching users:', error);
      loadingIndicator.classList.remove('active');
      userList.classList.remove('loading');
      userList.innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> An error occurred while searching. Please try again.
          </div>
        </div>
      `;
    });
}

// Create debounced search function (300ms delay)
const debouncedSearch = debounce(searchUsers, 300);

// Attach event listener to search input
document.getElementById('userSearchInput').addEventListener('input', function(e) {
  const query = e.target.value.trim();
  debouncedSearch(query);
});
</script>
{% endblock %}