{% extends 'base_content.html' %}
{% load static %}
{% load widget_tweaks %}

{% block body_class %}dashboard-bg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'navbar.css' %}">
<link rel="stylesheet" href="{% static 'dashboard.css' %}">
<link rel="stylesheet" href="{% static 'create_recipe.css' %}">
{% endblock %}

{% block content %}

<!-- Dust particles -->
<div class="dashboard-particles">
  {% for _ in "123456789012345678901234567890" %}
    <span></span>
  {% endfor %}
</div>

<div class="dashboard-wrapper">
  
  <!-- HERO -->
  <div class="dashboard-hero mb-5">
    <h1 class="dashboard-title">
      Create New <span class="accent-orange">Recipe</span>
    </h1>
    <p class="dashboard-subtitle">
      Share your culinary creation with the community
    </p>
  </div>

  <!-- FORM CONTAINER -->
  <div class="recipe-form-container">
    <form action="{% url 'create_recipe' %}" method="post" enctype="multipart/form-data" class="recipe-form" novalidate>
      {% csrf_token %}
      
      {# Show non-field errors #}
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-4">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      {# Standard form fields #}
      {% for field in form %}
        {% if field.name not in 'ingredient_count,instruction_count,image' and 'ingredient_' not in field.name and 'instruction_' not in field.name %}
          <div class="form-group">
            <label for="{{ field.id_for_label }}" class="form-label">
              {{ field.label }}{% if field.field.required %}<span class="required">*</span>{% endif %}
            </label>
            
            {% if field.name == 'meal_types' %}
              <div class="meal-types-grid">
                {{ field }}
              </div>
            {% elif field.name == 'description' %}
              {% render_field field class="form-control form-textarea" placeholder="Describe your delicious recipe" %}
            {% elif field.name == 'time' %}
              {% render_field field class="form-control" placeholder="30" %}
            {% elif field.name == 'title' %}
              {% render_field field class="form-control" placeholder="Enter recipe title" %}
            {% elif field.name == 'image_url' %}
              {% render_field field class="form-control" placeholder="https://example.com/image.jpg" %}
            {% else %}
              {% render_field field class="form-control" %}
            {% endif %}
            
            {% if field.errors %}
              <div class="field-error">{{ field.errors }}</div>
            {% endif %}
            {% if field.help_text %}
              <small class="field-help">{{ field.help_text }}</small>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      {# Custom Image Upload Section #}
      {% for field in form %}
        {% if field.name == 'image' %}
          <div class="form-group">
            <label for="{{ field.id_for_label }}" class="form-label">
              {{ field.label }}{% if field.field.required %}<span class="required">*</span>{% endif %}
            </label>
            
            {% render_field field class="custom-file-input" %}
            
            {% if field.errors %}
              <div class="field-error">{{ field.errors }}</div>
            {% endif %}
            {% if field.help_text %}
              <small class="field-help">{{ field.help_text }}</small>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      {# Hidden count fields #}
      {{ form.ingredient_count }}
      {{ form.instruction_count }}

      {# Dynamic Ingredients Section #}
      <div class="form-group">
        <label class="form-label">
          Ingredients <span class="required">*</span>
        </label>
        
        <div class="dynamic-fields">
          {% for field in form %}
            {% if 'ingredient_' in field.name %}
              <div class="dynamic-field-item">
                {% render_field field class="form-control" placeholder="e.g., 2 cups flour" %}
                {% if field.errors %}
                  <div class="field-error">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
        
        <div class="dynamic-buttons">
          <button type="submit" name="add_ingredient" value="1" class="btn-add" formnovalidate>
            Add Ingredient
          </button>
          {% if form.ingredient_count.value|add:"0" > 1 %}
            <button type="submit" name="remove_ingredient" value="1" class="btn-remove" formnovalidate>
              Remove Last
            </button>
          {% endif %}
        </div>
      </div>

      {# Dynamic Instructions Section #}
      <div class="form-group">
        <label class="form-label">
          Instructions <span class="required">*</span>
        </label>
        
        <div class="dynamic-fields">
          {% for field in form %}
            {% if 'instruction_' in field.name %}
              <div class="instruction-field-item">
                {% with step_num=field.name|slice:"12:"|add:"0"|add:1 %}
                  <span class="step-label">Step {{ step_num }}</span>
                {% endwith %}
                {% render_field field class="form-control form-textarea" placeholder="Describe this step in detail..." %}
                {% if field.errors %}
                  <div class="field-error">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
        
        <div class="dynamic-buttons">
          <button type="submit" name="add_instruction" value="1" class="btn-add" formnovalidate>
            Add Instruction
          </button>
          {% if form.instruction_count.value|add:"0" > 1 %}
            <button type="submit" name="remove_instruction" value="1" class="btn-remove" formnovalidate>
              Remove Last
            </button>
          {% endif %}
        </div>
      </div>

      {# Submit Buttons #}
      <div class="form-actions">
        <button type="submit" class="btn-primary">
          Create Recipe
        </button>
        <a href="{% url 'dashboard' %}" class="btn-secondary">
          Cancel
        </a>
      </div>
    </form>
  </div>

</div>

{% endblock %}